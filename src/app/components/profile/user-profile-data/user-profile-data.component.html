<div class="profile-container">
  <ng-container *ngIf="userProfile$ | async as userProfile">

    <div class="profile-header">
      <img [src]="userProfile.avatar || 'assets/images/no_profile_avatar.png'" alt="User Avatar" class="avatar">
      <h2>{{ userProfile.username }}</h2>
      <p><strong>–ù—ñ–∫–Ω–µ–π–º:</strong> {{ userProfile.nickname }}</p>
      <p><strong>Email:</strong> {{ userProfile.email }}</p>
      <p><strong>–†–æ–ª—å:</strong> {{ userProfile.role }}</p>
      <p><strong>–û—á–∫–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫–∏:</strong> {{ userProfile.behavior_points }}</p>
    </div>

    <hr>

    <div class="profile-section">
      <h3>üë§ –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
      <ng-container *ngIf="isGeneralEditMode; else viewGeneralInfo">
        <form [formGroup]="generalProfileForm">
          <label>–ê–≤–∞—Ç–∞—Ä</label>
          <input type="file" (change)="onAvatarChange($event)">
          <img *ngIf="avatarPreview" [src]="avatarPreview" alt="img" class="avatar-preview">

          <label>–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
          <input formControlName="username" type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è">

          <label>–°—Ç–∞—Ç—å</label>
          <input formControlName="gender" type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—Ç–∞—Ç—å">

          <label>–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
          <input formControlName="birthday" type="date" class="form-control">

          <label>–ö—Ä–∞—ó–Ω–∞</label>
          <input formControlName="country" type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫—Ä–∞—ó–Ω—É">

          <label>–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å</label>
          <input formControlName="time_zones" type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å">

          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input formControlName="phone_number" type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É">

          <label>–ë—ñ–∑–Ω–µ—Å email</label>
          <input formControlName="business_email" type="email" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å email">

          <label>–ü—Ä–æ —Å–µ–±–µ</label>
          <textarea formControlName="about_me" class="form-control" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ"></textarea>

          <label>üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó</label>
          <div formArrayName="technologies">
            <div *ngFor="let techControl of technologies.controls; let i = index">
              <input [formControl]="techControl" type="text" class="form-control" placeholder="–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è">
              <button type="button" (click)="removeTechnology(i)">‚ûñ</button>
            </div>
          </div>
          <button type="button" (click)="addTechnology()">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—é</button>

          <button type="button" (click)="saveGeneralProfile()" [disabled]="generalProfileForm.invalid">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
          </button>
          <button type="button" (click)="cancelGeneralEditMode()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
      </ng-container>

      <ng-template #viewGeneralInfo>
        <p><strong>–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</strong> {{ userProfile.username }}</p>
        <p><strong>–°—Ç–∞—Ç—å:</strong> {{ userProfile.gender }}</p>
        <p><strong>–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è:</strong> {{ userProfile.birthday || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>–ö—Ä–∞—ó–Ω–∞:</strong> {{ userProfile.country || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å:</strong> {{ userProfile.time_zones || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ userProfile.phone_number || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>–ë—ñ–∑–Ω–µ—Å email:</strong> {{ userProfile.business_email || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>–ü—Ä–æ —Å–µ–±–µ:</strong> {{ userProfile.about_me || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</p>
        <p><strong>üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó:</strong></p>
        <ul>
          <li *ngFor="let tech of userProfile.technologies">
            <strong>{{ tech.name }}</strong>: {{ tech.description || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π' }}
          </li>
        </ul>
        <button type="button" (click)="enterGeneralEditMode()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
      </ng-template>
    </div>

    <hr>

    <div class="profile-section">
      <h3>üîó –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ</h3>
      <ng-container *ngIf="isEditMode; else viewMode">
        <form [formGroup]="socialsForm">
          <ul>
            <li *ngFor="let key of objectKeys(userProfile.socials ?? {})">
              <strong>{{ key | titlecase }}:</strong>
              <input [formControlName]="key" type="text" [placeholder]="'–í–≤–µ–¥—ñ—Ç—å ' + key">
            </li>
          </ul>
          <button type="button" (click)="saveSocials()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
          <button type="button" (click)="cancelEditMode()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </form>
      </ng-container>

      <ng-template #viewMode>
        <ul>
          <li *ngFor="let key of objectKeys(userProfile.socials ?? {})">
            <strong>{{ key | titlecase }}:</strong> {{ userProfile.socials[key] || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}
          </li>
        </ul>
        <button type="button" (click)="enterEditMode()">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
      </ng-template>
    </div>

    <hr>

    <div class="profile-section">
      <h3>üéì –û—Å–≤—ñ—Ç–∞</h3>
      <ul>
        <li *ngFor="let edu of userProfile.education">{{ edu || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</li>
      </ul>
    </div>

    <div class="profile-section">
      <h3>üèÜ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</h3>
      <ul>
        <li *ngFor="let cert of userProfile.certificates">{{ cert || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}</li>
      </ul>
    </div>

    <div class="profile-section">
      <h3>üíº –†–æ–±–æ—Ç–∞</h3>

      <ul>
        <li *ngFor="let job of userProfile.jobs">
          <strong>–ö–æ–º–ø–∞–Ω—ñ—è:</strong> {{ job.company?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}<br>
          <strong>–ü–æ—Å–∞–¥–∞:</strong> {{ job.position || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}<br>
          <strong>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É:</strong> {{ job.started_at || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' }}<br>
          <strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è:</strong>
          {{ job.ended_at ? job.ended_at : '–û–±—ñ–π–º–∞—é —Ü—é –ø–æ—Å–∞–¥—É –¥–æ—Å—ñ' }}<br>
          <strong>–û–ø–∏—Å:</strong> {{ job.description || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π' }}

          <button type="button" (click)="deleteJob(job.id, job.position)">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
        </li>
      </ul>

      <button *ngIf="!isAddingJob" type="button" (click)="toggleAddJob()">‚ûï –î–æ–¥–∞—Ç–∏ —Ä–æ–±–æ—Ç—É</button>

      <form *ngIf="isAddingJob" [formGroup]="newJobForm">
        <label>–ö–æ–º–ø–∞–Ω—ñ—è</label>
        <input formControlName="companyName" type="text" class="form-control" placeholder="–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó">

        <label>–ü–æ—Å–∞–¥–∞</label>
        <input formControlName="position" type="text" class="form-control" placeholder="–ü–æ—Å–∞–¥–∞">

        <label>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
        <input type="date" formControlName="started_at" class="form-control" max="{{ today }}">

        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            formControlName="isCurrentlyEmployed"
          />
          <label class="form-check-label">–û–±—ñ–π–º–∞—é —Ü—é –ø–æ—Å–∞–¥—É –¥–æ—Å—ñ</label>
        </div>

        <div class="mb-3">
          <label>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è</label>
          <input formControlName="ended_at" type="date" class="form-control">
        </div>

        <label>–û–ø–∏—Å</label>
        <textarea formControlName="description" class="form-control" placeholder="–û–ø–∏—Å"></textarea>

        <button type="button" (click)="saveNewJob()" [disabled]="newJobForm.invalid">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button type="button" (click)="cancelAddJob()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </form>
    </div>

    <hr>

    <form [formGroup]="newPasswordForm" class="security-form">
      <h3>üîë –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</h3>
      <label>–°—Ç–∞—Ä–∏–π –ø–∞—Ä–æ–ª—å</label>
      <input formControlName="current_password" type="password" class="form-control">

      <label>–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
      <input formControlName="new_password" type="password" class="form-control">

      <label>–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
      <input formControlName="confirm_password" type="password" class="form-control">

      <button type="button" (click)="changeProfilePassword()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
    </form>
  </ng-container>

  <div class="blacklist-section">
    <h3>üö´ –ß–æ—Ä–Ω–∏–π —Å–ø–∏—Å–æ–∫</h3>
    <ng-container *ngIf="blackListUsers.length > 0; else noUsers">
      <div *ngFor="let user of blackListUsers" class="blacklist-user">
        <img src="assets/images/no_profile_avatar.png" class="user-avatar" alt="User Avatar" />
        <div class="user-details">
          <span class="nickname">{{ user.blocked_user.nickname }}</span>
        </div>
        <button class="unblock-button" (click)="unblockUser(user.blocked_user.id)">üöÄ –†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
      </div>
    </ng-container>
    <ng-template #noUsers>
      <p>üïäÔ∏è –£ –≤–∞—à–æ–º—É —á–æ—Ä–Ω–æ–º—É —Å–ø–∏—Å–∫—É –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>
    </ng-template>
  </div>
</div>
